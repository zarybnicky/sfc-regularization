#+LATEX_CLASS: article
#+LATEX_CLASS_OPTIONS: [titlepage]
#+LATEX_HEADER: \usepackage{minted}
#+OPTIONS: tags:nil creator:nil tasks:nil toc:nil

#+AUTHOR: Jakub Zárybnický, xzaryb00
#+TITLE: Demonstrace učení BP - regularizace
#+SUBTITLE: Předmět Soft Computing, zimní semestr 2019/20, FIT VUT Brno
#+DATE: 9. 12. 2019

#+begin_src emacs-lisp :exports results :results none :eval export
  (make-variable-buffer-local 'org-confirm-babel-evaluate)
  (setq org-confirm-babel-evaluate nil)
#+end_src

* Úvod do problematiky
Backpropagation je způsob, jak zabránit přetrénování neuronové sítě nad
trénovací množinou dat tak, ať je schopná generalizovat i na data jiná,
např. testovací množinu dat.

Technik pro zabránění přetrénování je celá řada, mimo regularizaci existují
např.:

- dropout - technika, kdy jsou v jednotlivých vrstvách během učení náhodně
  vypojovány neurony
- šum - zavedení šumu do vstupních dat
- včasné zastavení - monitorování přesnosti sítě na testovacích datech a
  zastavení v případě, že se začne snižovat (přiznak přetrénování)

Regularizace přetrénování zabraňuje jiným způsobem, a to tak, že omezuje
velikosti jednotlivých koeficientů vah. Existují dva typy:

- L1 - Lasso Regression, která omezuje součet čtverců váhových koeficientů a
- L2 - Ridge Regression, která omezuje součet absolutní hodnoty váhových koeficientů

Oba dva způsoby přidávají další krok do zpětné propagace, kdy jsou na konci
kroku učení přičteny nejen změny vah opravující chybu, ale i další členy, které
zmenšují váhové koeficienty.

\newpage
* Implementace
Pro implementaci jsem neuronové sítě, učení zpětnou propagací a regularizaci
jsem zvolil jazyk Java a nejbližší ekvivalent knihovny Numpy, co jsem v Javě
našel, kterým byla knihovna ND4J, která je součástí projektu
DeepLearning4J. ND4J obsahuje funkce pro práci s n-rozměrnými maticemi, což
bohatě stačí pro implementaci neuronové sítě, a mnohonásobně zjednodušuje práci
oproti ručnímu psaní maticových operací.

Pro překlad a spuštění programu stačí v adresáři se zdrojovými soubory spustit
příkazem:

#+BEGIN_SRC bash
make
#+END_SRC

který si následně stáhne všechny potřebné závislosti, přeloží program a spustí
ho. Předdefinovanými parametry je sada dat Iris, vnitřní vrstva o šířce 10,
rychlost učení 0.01 a parametr regularizace 5.

Na výstupu běhu ukázkového programu je průběh 1000 epoch paralelního učení tří
sítí, které vycházejí ze stejných parametrů i náhodných úvodních vah.

Na výstupu se každých deset epoch učení objeví počet chyb, které síť udělá nad
testovacími daty, a cenová funkce z poslední dávky učení.

\newpage
* Výsledky

V následujícím grafu jsou zakreslené výsledky získané během učení náhodně
inicializované dvouvrstvé plně propojené neuronové sítě (šířky vrstev 4, 6, 3 v
prvním obrázku, 4, 10, 3 v druhém, aktivační funkce sigmoida, one-hot kódování
ve výstupní vrstvě) třemi způsoby - bez regularizace, s L1 regularizací a s L2
regularizací.

Zakreslená je kvadratická cenová funkce (/mean square error (or loss) function/)
proti epochám učení (jeden bod je každých 10 epoch).

Výsledné grafy se při mém testování často velmi lišily běh od běhu, což je
způsobené inicializací vah v síti náhodnými hodnotami.

#+ATTR_LATEX: :float t
#+BEGIN_SRC ipython :session :exports results :kernel ipython_python :var src_raw=src6 :results raw drawer
  %matplotlib inline
  import matplotlib.gridspec as gridspec
  import matplotlib.pyplot as plt
  import numpy as np
  import pandas as pd
  from tabulate import tabulate

  def show(*args, headers='keys', **kwargs):
      print(tabulate(*args, tablefmt='orgtbl', headers=headers, **kwargs))

  src = pd.DataFrame(src_raw, columns=['i', 'no_reg', 'l1_reg', 'l2_reg'])

  fig, ax = plt.subplots(figsize=(8, 5))
  src.plot.line(ax=ax, x='i', y='no_reg')
  src.plot.line(ax=ax, x='i', y='l1_reg')
  src.plot.line(ax=ax, x='i', y='l2_reg')
  plt.tight_layout()
#+END_SRC

#+RESULTS:
:RESULTS:
# Out[16]:
[[file:./obipy-resources/yWOR0g.png]]
:END:

#+ATTR_LATEX: :float t
#+BEGIN_SRC ipython :session :exports results :kernel ipython_python :var src_raw=src10 :results raw drawer
  src = pd.DataFrame(src_raw, columns=['i', 'no_reg', 'l1_reg', 'l2_reg'])
  fig, ax = plt.subplots(figsize=(8, 5))
  src.plot.line(ax=ax, x='i', y='no_reg')
  src.plot.line(ax=ax, x='i', y='l1_reg')
  src.plot.line(ax=ax, x='i', y='l2_reg')
  plt.tight_layout()
#+END_SRC

#+RESULTS:
:RESULTS:
# Out[24]:
[[file:./obipy-resources/XslvfP.png]]
:END:


* Source                                                        :noexport:
#+TBLNAME: src6
|0|105.29914943645983|105.29914943645983|105.29914943645983|
|10|100.43611800707963|100.44469047318685|100.38511043784221|
|20|96.22517398472257|96.3627216407954|96.15753717290478|
|30|94.4828780574349|94.72813000438344|94.39095087772891|
|40|92.96474274306475|93.30313684912448|92.84281991550007|
|50|91.43427253703935|91.87043726581278|91.28312578114974|
|60|89.88519386121891|90.42413728620951|89.70629496965|
|70|88.32021435203858|88.96623180147485|88.11554659222246|
|80|86.74326307017985|87.49971361863898|86.51529914720251|
|90|85.1587325368224|86.02791901514902|84.91040728803041|
|100|83.57130608851352|84.55439791516399|83.30597264649705|
|110|81.98585875600264|83.08284987571834|81.70722845636439|
|120|80.40736499225893|81.6170659602531|80.11943358908326|
|130|78.84080492722839|80.16086830011781|78.54776868555432|
|140|77.29107095072958|78.71804789500509|76.9972367346723|
|150|75.76287824291781|77.29230282838432|75.47257191204173|
|160|74.26068284975814|75.88717930176665|73.97816013779456|
|170|72.7886103371589|74.50601778810949|72.517973952664|
|180|71.35039728082523|73.15190633702704|71.09552330160751|
|190|69.9493469853433|71.82764261850213|69.71382280118057|
|200|68.58829995567115|70.52385737514142|68.3753751394961|
|210|67.26961883390794|69.149643462481|67.08216947688692|
|220|65.99518682046698|67.81547084708406|65.83569311902873|
|230|64.76641806305572|66.52356751599397|64.63695433792685|
|240|63.58427813998697|65.24112446474709|63.486514015329156|
|250|62.44931258450335|63.92709939059653|62.38452375674412|
|260|61.361681372930036|62.6654816184661|61.33076823972514|
|270|60.321197398831636|61.45719483196802|60.32470977907964|
|280|59.327367141761925|60.30262656136351|59.36553337562599|
|290|58.379431979175685|59.20168269860032|58.45219082958951|
|300|57.4764088558234|58.1538458247567|57.583442816910285|
|310|56.61712929490158|57.158234787577655|56.757898126286136|
|320|55.800275993492285|56.213663410540065|55.97404952341907|
|330|55.02441648032264|55.31869666770835|55.230305939323415|
|340|54.288033519681|54.47170309585264|54.52502086898611|
|350|53.58955211796584|53.670902616535535|53.856517015791034|
|360|52.9273631281975|52.91440929134366|53.22310732888551|
|370|52.2998435544293|52.200268824843896|52.623112659391836|
|380|51.70537373538143|51.526490860030975|52.05487631206366|
|390|51.14235163868027|50.891076282793634|51.5167757968029|
|400|50.60920452805996|50.29203987136799|51.007232094313835|
|410|50.10439827997993|49.72742870175061|50.52471674652451|
|420|49.62644462722613|49.19533675906919|50.06775706910142|
|430|49.1739065986443|48.69391621611046|49.63493976362493|
|440|48.74540240911504|48.22138583091824|49.224913183349116|
|450|48.339608034609014|47.776036891869815|48.836388480926146|
|460|47.95525868554165|47.35623710602032|48.468139840527215|
|470|47.59114936911223|46.96043278878331|48.11900397148405|
|480|47.246134708923954|46.58714967319942|47.78787901663764|
|490|46.91912816866979|46.234992617303234|47.4737230064483|
|500|46.609100806528744|45.902644449898865|47.175551969836185|
|510|46.31507966842862|45.58886415932284|46.89243779477458|
|520|46.03614591164269|45.29248459701341|46.62350591582002|
|530|45.771432735323586|45.012409838120654|46.367932891951035|
|540|45.52012318150045|44.747612314971484|46.124943926152504|
|550|45.28144785867555|44.497129815804634|45.89381036796534|
|560|45.05468263032944|44.26006242059973|45.67384723154394|
|570|44.83914630223932|44.03556942779811|45.46441075445041|
|580|44.63419833538181|43.82286631004279|45.26489601629091|
|590|44.43923660518509|43.62122172357005|45.07473463121144|
|600|44.2536952228745|43.42995458448294|44.89339252406391|
|610|44.07704243049206|43.24843121581475|44.72036779659928|
|620|43.90877857773957|43.07606256212801|44.55518868722248|
|630|43.74843418599779|42.91230146354511|44.3974116255459|
|640|43.595568102605206|42.75663997874173|44.24661938111284|
|650|43.44976574666534|42.60860674669498|44.102419304147716|
|660|43.310637446208304|42.46776437988433|43.96444165494833|
|670|43.177816865406506|42.333706887002485|43.83233801751063|
|680|43.05095951967251|42.20605713056067|43.705779792104295|
|690|42.92974137580973|42.08446433325614|43.584456760750626|
|700|42.81385753389927|41.96860165547845|43.4680757188473|
|710|42.70302098725518|41.858163873537464|43.356359165497686|
|720|42.59696145654191|41.752865192764475|43.24904404440576|
|730|42.49542429398811|41.65243723046854|43.14588052647325|
|740|42.398169453536774|41.556627200235724|43.04663082449466|
|750|42.304970522722755|41.46519632134656|42.95106802964069|
|760|42.21561381204387|41.3779184659977|42.858974958902614|
|770|42.129897497584|41.29457904403663|42.77014300265763|
|780|42.04763081263454|41.21497411185505|42.68437096265627|
|790|41.96863328403406|41.138909680735374|42.60146387427699|
|800|41.892734008889285|41.06620119169149|42.52123181522581|
|810|41.819770967232685|40.99667311946843|42.4434887204017|
|820|41.74959036599724|40.9301586679186|42.36805125751151|
|830|41.68204600941545|40.86649952191466|42.29473788460589|
|840|41.61699869054449|40.80554562633834|42.223368333542574|
|850|41.554315598030406|40.74715496939951|42.15376398079931|
|860|41.49386973138814|40.69119335456388|42.0857499288605|
|870|41.43553931688417|40.6375341518853|42.01916016110198|
|880|41.37920721442969|40.58605802502426|41.95384776661606|
|890|41.324760303501655|40.53665263443972|41.8897025007174|
|900|41.27208883268956|40.48921232013582|41.82667659507548|
|910|41.2210857125124|40.443637769070506|41.76481460950589|
|920|41.1716457238751|40.39983567309035|41.704273168310586|
|930|41.123664603670484|40.35771838329933|41.645307426242766|
|940|41.07703795249332|40.31720356632253|41.58820893388832|
|950|41.031659883694246|40.278213867188434|41.53321328513224|
|960|40.987421291968886|40.24067658267983|41.48042848190503|
|970|40.94420755245826|40.2045233481062|41.429823340859635|
|980|40.901895347905054|40.16968983960014|41.3812680781449|
|990|40.860348123591216|40.136115493285146|41.33458982439835|

#+TBLNAME: src10
|0|69.36945731405909|69.36945731405909|69.36945731405909|
|10|67.47783156691932|67.44100182836027|67.49115092530303|
|20|65.86900189169468|65.81254225647115|65.89561042317757|
|30|64.26946765012988|64.2068609603017|64.31029688252374|
|40|62.67187706177478|62.614838284386835|62.72855221949697|
|50|61.07929020066503|61.01075012235577|61.154067865537606|
|60|59.497001612905066|59.33682693377685|59.5926970671165|
|70|57.931832203777624|57.63845685202676|58.05169435173124|
|80|56.391864272231665|55.964692424958436|56.53939555150282|
|90|54.88603256136689|54.32947762952259|55.06477004432496|
|100|53.423590207807536|52.74285429365878|53.636872992610144|
|110|52.01353173769431|51.21479751932829|52.26428215709201|
|120|50.66405077781051|49.754527057092204|50.954593967711524|
|130|49.38209330242946|48.36992284633045|49.71403251724316|
|140|48.17304516197349|47.06710327073631|48.54720084263949|
|150|47.04056887873527|45.85019239216507|47.456980075460734|
|160|45.98658316124307|44.72127190755425|46.444562326087414|
|170|45.01136246833726|43.68049010413466|45.509589915287364|
|180|44.11372478298296|42.72628640089097|44.65036744176041|
|190|43.29127331761407|41.85568610196289|43.864113276096944|
|200|42.54066069195421|41.06462365997989|43.14722156815791|
|210|41.8578501787517|40.348261071065906|42.49551268033637|
|220|41.23835595608966|39.70127812307245|41.90445733433564|
|230|40.677451444602674|39.11812092547186|41.36936644894333|
|240|40.170340831527334|38.59320318367258|40.88554398987826|
|250|39.71229340265323|38.121060546969446|40.44840395493529|
|260|39.2987433096011|37.69646211052414|40.05355498983954|
|270|38.92535910683732|37.31448514088868|39.69685734108775|
|280|38.588088105245625|36.97055978117185|39.37445721594336|
|290|38.28318061557914|36.66049031847943|39.08280342842312|
|300|38.00719876061566|36.38045892689452|38.81865070031256|
|310|37.75701392253398|36.12701690185157|38.579053331546355|
|320|37.52979620374821|35.89706745457566|38.361352270667226|
|330|37.322998605112964|35.687843244634095|38.16315797335839|
|340|37.13433801550256|35.496881048740796|37.98233087140992|
|350|36.96177458420065|35.32199531432561|37.81696079950672|
|360|36.8034906175282|35.16125182568561|37.66534634259588|
|370|36.657869798597424|35.01294230625937|37.525974764330144|
|380|36.523477263704464|34.87556047542572|37.3975029457655|
|390|36.39904086845248|34.74777985405167|37.278739590846904|
|400|36.28343382907667|34.62843345286356|37.16862882959703|
|410|36.175658818559896|34.516495366868554|37.0662352610524|
|420|36.07483352347471|34.4110642253054|36.97073041719751|
|430|35.980177618202916|34.311348400164015|36.881380589382914|
|440|35.891001081955935|34.216652849546215|36.79753593437806|
|450|35.80669376590555|34.12636745921109|36.71862076396464|
|460|35.726716108931655|34.039956742186284|36.644124916515594|
|470|35.65059089813433|33.95695075911541|36.57359610884844|
|480|35.577895972204814|33.876937128726304|36.50663316996627|
|490|35.508257770450456|33.79955400679027|36.44288006378003|
|500|35.44134563659954|33.7244839220534|36.38202061459967|
|510|35.37686679368339|33.651448368077084|36.32377385643145|
|520|35.31456191376222|33.58020306021439|36.26788993447767|
|530|35.25420121366653|33.510533776755885|36.21414649440958|
|540|35.19558101502891|33.442252712414145|36.162345501790526|
|550|35.13852071354872|33.375195280692175|36.11231044036046|
|560|35.082860108584235|33.30921730926494|36.063883843703216|
|570|35.02845704977652|33.24419257930767|36.01692512008946|
|580|34.97518536247523|33.18001066576719|35.97130863503344|
|590|34.922933018278876|33.116575040939374|35.926922020341806|
|600|34.8716005210507|33.053801408453005|35.88366468220517|
|610|34.821099482364225|32.99161623891947|35.841446484225074|
|620|34.771351363509496|32.929955482156096|35.80018658421811|
|630|34.722286363991785|32.86876343408042|35.75981240623831|
|640|34.6738424389192|32.8079917391585|35.72025873154229|
|650|34.62596442983927|32.74759851172018|35.681466894226055|
|660|34.578603295483106|32.68754756157226|35.64338406902049|
|670|34.5317154305396|32.627807711183756|35.60596264027035|
|680|34.48526206203703|32.568352193325644|35.56915964247037|
|690|34.43920871418642|32.509158119443214|35.532936263910486|
|700|34.39352473365449|32.45020601025909|35.49725740601415|
|710|34.34818286821162|32.391479381163336|35.462091291856176|
|720|34.30315889255378|32.332964375872095|35.427409118136474|
|730|34.2584312758445|32.27464944263974|35.393184745577905|
|740|34.213980886178724|32.21652504801268|35.359394423320026|
|750|34.16979072774204|32.15858342372413|35.326016543412855|
|760|34.12584570694233|32.100818342864294|35.293031421976934|
|770|34.08213242423046|32.04322492192677|35.2604211040048|
|780|34.038638988713195|31.985799445740735|35.22816918913496|
|790|33.99535485300015|31.928539212654716|35.19626067604342|
|800|33.95227066602521|31.87144239765129|35.16468182337306|
|810|33.9093781418432|31.81450793134515|35.133420025362234|
|820|33.86666994263415|31.757735393057754|35.10246370054766|
|830|33.82413957434893|31.701124916372223|35.07180219210319|
|840|33.781781293609185|31.644677105757673|35.04142567854027|
|850|33.739590024631134|31.58839296301469|35.01132509364222|
|860|33.697561285082195|31.532273822437173|34.981492054631204|
|870|33.65569111990124|31.476321293711727|34.95191879768044|
|880|33.61397604222168|31.42053721168722|34.92259811998322|
|890|33.572412980632095|31.364923592244832|34.893523327679134|
|900|33.53099923209404|31.309482593586075|34.86468818901446|
|910|33.48973241991099|31.254216482332172|34.836086892184184|
|920|33.44861045620909|31.199127603896198|34.807714007362115|
|930|33.40763150844943|31.14421835664943|34.779564452481345|
|940|33.36679396954267|31.08949116945567|34.751633462373576|
|950|33.326096431184936|31.034948482195144|34.723916560919506|
|960|33.28553766007313|30.980592728940586|34.69640953589906|
|970|33.2451165766958|30.926426323485508|34.669108416264386|
|980|33.20483223642762|30.87245164695732|34.642009451587725|
|990|33.16468381268443|30.818671037277156|34.615109093463175|
